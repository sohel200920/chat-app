<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat | Chat App</title>
  <style>
    :root {
      --primary-bg: #111b21;
      --secondary-bg: #202c33;
      --text-color: #e9edef;
      --accent-green: #25d366;
      --message-bg-you: #005c4b;
      --message-bg-other: #2a3942;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      height: 100vh;
      display: flex;
      background: var(--primary-bg);
      color: var(--text-color);
    }

    #sidebar {
      width: 280px;
      background: var(--secondary-bg);
      border-right: 1px solid #2f3b43;
      display: flex;
      flex-direction: column;
    }

    #sidebar header {
      background: var(--accent-green);
      color: white;
      padding: 20px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
    }

    #loggedInUser {
      background: #b30000;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 10px;
    }

    #userList {
      flex-grow: 1;
      overflow-y: auto;
    }

    .user {
      padding: 12px 16px;
      border-bottom: 1px solid #2f3b43;
      cursor: pointer;
      display: flex;
      align-items: center;
      color: white;
      gap: 12px;
    }

    .user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .user:hover {
      background: #1f2c34;
    }

    .user.active {
      background: var(--accent-green);
      color: white;
    }

    .notification-badge {
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 50%;
      margin-left: auto;
      display: none;
    }

    #mainChat {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #chatHeader {
      background: var(--secondary-bg);
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      font-size: 18px;
      border-bottom: 1px solid #2f3b43;
    }

    #chatMessages {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      display: inline-block;
      max-width: 70%;
      word-wrap: break-word;
    }

    .message.other {
      flex-direction: row;
      align-self: flex-start;
    }

    .message.you {
      flex-direction: row-reverse;
      align-self: flex-end;
    }

    .message img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin: 0 10px;
      object-fit: cover;
    }

    .message .text {
      background: var(--message-bg-other);
      color: white;
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 100%;
      word-wrap: break-word;
    }

    .message.you .text {
      background: var(--message-bg-you);
    }

    #chatInput {
      padding: 10px 15px;
      background: var(--secondary-bg);
      border-top: 1px solid #2f3b43;
      display: flex;
    }

    #messageInput {
      flex-grow: 1;
      padding: 12px 15px;
      border-radius: 25px;
      border: none;
      font-size: 16px;
      outline: none;
    }

    #sendBtn {
      background: var(--accent-green);
      color: white;
      border: none;
      padding: 12px 20px;
      margin-left: 10px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .seenText {
      font-size: 11px;
      color: #aaa;
      text-align: right;
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <header>Contacts</header>
    <div id="loggedInUser"></div>
    <div id="userList"></div>
  </div>

  <div id="mainChat">
    <div id="chatHeader">Select a user to chat</div>
    <div id="chatMessages"></div>
    <div id="chatInput" style="display:none;">
      <input type="text" id="messageInput" placeholder="Type a message" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const username = localStorage.getItem('username');
    if (!username) window.location.href = 'login.html';
    const lastUser = localStorage.getItem('lastUser');
    if (lastUser) {
      localStorage.setItem('username', lastUser);
      window.location.href = 'chat.html';
    }


    document.getElementById('loggedInUser').textContent = `Logged in as: ${username}`;

    let currentChatUser = null;
    let usersData = [];

    async function loadUsers() {
      const res = await fetch(`/users/${username}`);
      const users = await res.json();
      usersData = users;

      const userList = document.getElementById('userList');
      userList.innerHTML = '';

      users.forEach(user => {
        const div = document.createElement('div');
        div.classList.add('user');

        const img = document.createElement('img');
        img.src = user.profilePic ? `/uploads/${user.profilePic}` : 'default.png';
        img.onerror = () => img.src = 'default.png';

        const name = document.createElement('span');
        name.textContent = user.username;

        const badge = document.createElement('span');
        badge.classList.add('notification-badge');
        badge.textContent = '1';
        badge.style.display = 'none';

        div.appendChild(img);
        div.appendChild(name);
        div.appendChild(badge);

        div.addEventListener('click', () => {
          openChat(user.username, div);
          badge.style.display = 'none';
        });

        userList.appendChild(div);
      });
    }

    async function openChat(userToChat, userDiv) {
      currentChatUser = userToChat;
      document.getElementById('chatHeader').textContent = 'Chat with ' + userToChat;
      document.getElementById('chatInput').style.display = 'flex';

      document.querySelectorAll('.user').forEach(u => u.classList.remove('active'));
      userDiv.classList.add('active');

      loadMessages();
    }

    async function loadMessages() {
      if (!currentChatUser) return;
      const res = await fetch(`/chat/${username}/${currentChatUser}`);
      const messages = await res.json();

      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';

      messages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(msg.from === username ? 'you' : 'other');

        const img = document.createElement('img');
        const sender = msg.from === username ? username : currentChatUser;
        const userInfo = usersData.find(u => u.username === sender);
        img.src = userInfo?.profilePic ? `/uploads/${userInfo.profilePic}` : 'default.png';
        img.onerror = () => img.src = 'default.png';

        const text = document.createElement('div');
        text.classList.add('text');
        text.textContent = msg.message;

        div.appendChild(img);
        div.appendChild(text);
        chatMessages.appendChild(div);
      });

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message || !currentChatUser) return;

      const res = await fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: username, to: currentChatUser, message }),
      });

      if (res.ok) {
        input.value = '';
        loadMessages();
      } else {
        alert("Failed to send message");
      }
    }

    async function checkNewMessages() {
      const res = await fetch(`/chat/${username}`);
      const msgs = await res.json();

      document.querySelectorAll('.user').forEach(div => {
        const target = div.querySelector('span').textContent;
        const badge = div.querySelector('.notification-badge');
        const count = msgs.filter(m => m.from === target && m.to === username).length;
        if (target !== currentChatUser && count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      });
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    setInterval(() => {
      if (currentChatUser) loadMessages();
      checkNewMessages();
    }, 2000);

    loadUsers();
    if (msg.from === username && index === messages.length - 1 && msg.seen)
      div.innerHTML += '<div class="seenText">Seen just now</div>';

  </script>
</body>

</html>