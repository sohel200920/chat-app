<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChatApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --green: #25d366;
      --dark: #075e54;
      --light: #e9fff1;
      --gray: #232f34;
      --nav-bg: linear-gradient(100deg, #075e54 65%, #24bc5a 105%);
      --shadow: 0 8px 32px #1930172b, 0 1.5px 12px #25d3662b;
      --font: 'Segoe UI', Tahoma, Verdana, Geneva, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family:var(--font); background: #111b21; height: 100%; }
    body { display: flex; flex-direction: column; min-height: 100vh; }

    /* NAVBAR */
    .navbar {
      background: var(--nav-bg);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 13px 23px 11px 21px;
      font-size: 1.5em; font-weight: bold;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0; z-index: 999;
    }
    .navbar-title { letter-spacing: 0.6px; }
    .navbar-profile-pic {
      width: 38px; height: 38px;
      border-radius: 50%; object-fit: cover;
      border: 2px solid #fff4;
      box-shadow: 0 1.5px 9px #075e5462;
      cursor: pointer;
    }

    /* SEARCH BAR */
    .search-bar-wrap {
      width: 100%; background: #fff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1.5px 10px -5px #25d36622;
      z-index: 2;
    }
    .search-bar {
      width: 96vw; max-width: 500px;
      border: 1.6px solid #25d36640;
      border-radius: 22px; background: #f2faf6;
      padding: 12px 18px; font-size: 17px; color: #263238;
      margin: 13px 0 13px 0;
      outline: none;
      transition: box-shadow 0.2s, border 0.18s;
    }
    .search-bar:focus {
      border-color: #25d366;
      box-shadow: 0 0 0 2.5px #25d36644;
      background: #e6fcf4;
    }

    /* FLEX MAIN */
    .main {
      flex: 1; display: flex; flex-direction: row; min-height: 0;
      background: #121b23;
      overflow: hidden;
    }
    .user-list {
      flex: 0 0 330px;
      background: #182a21f8; border-right: 2.5px solid #25d36613;
      min-width: 200px; max-width: 350px;
      overflow-y: auto;
      box-shadow: 3px 0 24px -12px #25d36612;
      z-index: 11;
      /* for sticky/fixed on mobile */
    }
    .contact {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 15px 12px 18px;
      background: #232f34e8; border-radius: 15px; margin: 10px 9px 8px 7px;
      cursor: pointer; user-select: none;
      border: 1.25px solid transparent;
      transition: background 0.2s, border 0.16s;
      position: relative;
    }
    .contact:hover, .contact.active {
      background: #19d28d27;
      border-color: #25d366c4;
    }
    .contact-img {
      width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
      background: #f4f4f4;
      border: 2.5px solid #16d68856;
      box-shadow: 0 1.5px 10px #25d3662a;
      margin-right: 3px;
    }
    .contact-details { flex: 1; display: flex; flex-direction: column; }
    .contact-username { font-weight: 600; font-size: 17.2px; color: #fff; }
    .contact-lastseen { color: #b0eeca; font-size: 13px; margin-top: 1px; opacity: 0.83; }
    .online-dot {
      width: 13px; height: 13px; border-radius: 50%; background: #1ce448;
      position: absolute; left: 39px; top: 39px; border: 2.1px solid #fff;
      box-shadow: 0 0 11px 1px #23f3668b;
      display: inline-block;
    }
    .friend-btn {
      margin-left: auto; background: #fff4;
      border: none; color: #26da77; font-weight: 700; border-radius: 18px;
      padding: 5px 13px; font-size: 14px; cursor: pointer;
      transition: background 0.18s, color 0.16s;
    }
    .friend-btn:hover { background: #19d28d26; color: #25d366;}

    /* CHAT SECTION */
    .chat-section {
      flex: 1 1 0%; display: flex; flex-direction: column;
      background: #141e25; min-width: 0;
    }
    .chat-header {
      padding: 18px 28px 15px 23px;
      font-size: 19px; font-weight: bold;
      color: #e9edef; background: var(--gray);
      display: flex; align-items: center; gap: 14px;
      border-bottom: 2px solid #21e49015;
      min-height: 46px; user-select: none; letter-spacing: 0.2px;
      box-shadow: 0 2px 12px -7px #25d36631;
    }
    /* Back button for mobile */
    .chat-back-btn {
      display: none;
      font-size: 24px; background: none; border: none;
      color: var(--green);
      cursor: pointer;
      padding: 0 10px 4px 0;
      user-select: none;
    }

    .chat-main-msgs {
      flex: 1; overflow-y: auto; padding: 22px 23px 45px 30px;
      background: linear-gradient(120deg,#101e23 80%,#1a4633 110%);
      display: flex; flex-direction: column; gap: 17px;
    }
    .chat-input-bar {
      padding: 9.5px 21px 12px 15px; background: #182a21f3;
      display: flex; gap: 13px; align-items: center; min-height: 55px;
      border-top: 2.2px solid #25d36622;
      z-index: 20;
    }
    .msg-input {
      flex: 1; font-size: 18px; background: #f2faf6;
      border-radius: 17px; padding: 13px 19px;
      border: none; outline: none; margin-right: 8px;
    }
    .msg-send-btn {
      background: linear-gradient(90deg,#25d366 65%,#128c4a 100%);
      border-radius: 17px; color: #fff; font-weight: 600;
      border: none; padding: 10px 23px; cursor: pointer; font-size: 17px;
      box-shadow: 0 2.5px 11px #25d36647;
      transition: background 0.17s, color 0.15s, box-shadow 0.16s;
    }
    .msg-send-btn:hover { background: #1ebc5b; }
    /* Chat bubbles */
    .chat-bubble-row {
      display:flex; align-items:flex-end; margin-bottom:8px;
    }
    .chat-bubble-row.me { flex-direction:row-reverse; }
    .chat-bubble-avatar {
      width:36px; height:36px; border-radius:50%; object-fit:cover;
      background:#fff;
      margin:0 9px;
      border: 2px solid #25d36626;
    }
    .chat-bubble {
      background: #232f34e8; color: #eee; padding: 12px 18px;
      border-radius: 17px 17px 17px 7px; min-width: 10px;
      font-size: 16.2px; box-shadow: 0 2.5px 12px -7px #0c3a2f99;
      max-width: 73vw; word-break: break-word; position:relative;
    }
    .chat-bubble.me {
        background: linear-gradient(95deg,#07847e 55%,#25d366 90%);
        color: #e7ffee;
        border-radius:17px 17px 7px 17px;
        font-weight:500;
        box-shadow: 0 2px 14px -8px #25d36633;
    }
    .seen-tick { font-size: 15px; color: #25d366; margin-left: 8px;}
    /* Responsive */
    @media (max-width: 830px) {
      .main { flex-direction: column; }
      .user-list {border-right:none; border-bottom:2px solid #25d36617; max-width:none;}
      .chat-section {width:100vw;}
    }
    @media (max-width: 700px) {
      .user-list { display: block; width: 100vw; max-width: none; border-right: none; }
      .chat-section { display: none; }      /* Hide chat section by default */
      body.show-chat .user-list { display: none; }
      body.show-chat .chat-section { display: flex; width: 100vw; }
      .chat-header .chat-back-btn { display: inline-block; }
    }
    @media (max-width: 550px) {
      .search-bar { width: 89vw; font-size: 16px;}
      .chat-main-msgs { padding:14px 1vw 63px 2vw; }
      .user-list {min-width:0;}
      .contact-img { width:38px; height:38px;}
      .chat-bubble-avatar { width:29px; height:29px; }
      .chat-header { font-size:17px; padding:11px 2vw 12px 3vw;}
      .chat-input-bar {padding:5px 2vw 9px 3vw;}
      .msg-input { font-size:15px; padding:10px 10px;}
      .msg-send-btn { font-size:15.5px; padding:7px 12px;}
    }
    @media (max-width:380px) {
      .chat-bubble {font-size: 14.7px;}
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-title">ChatApp</div>
    <img class="navbar-profile-pic" id="profilePicNavbar" src="default.png" alt="Profile" />
  </div>
  <!-- SEARCH BAR -->
  <div class="search-bar-wrap">
    <input id="searchBar" class="search-bar" type="text" placeholder="Search users..." autocomplete="off"/>
  </div>
  <!-- FLEX MAIN BODY (Contacts + Chat, responsive) -->
  <div class="main">
    <!-- USER CONTACTS LIST -->
    <div class="user-list" id="userList"></div>
    <!-- CHAT AREA -->
    <div class="chat-section">
      <div class="chat-header" id="chatHeader">
        <button class="chat-back-btn" id="backBtn" title="Back to contacts">←</button>
        <span id="chatHeaderText">Select a user to chat</span>
      </div>
      <div class="chat-main-msgs" id="chatMessages"></div>
      <div class="chat-input-bar" id="chatInputBar" style="display:none;">
        <input type="text" class="msg-input" id="chatMsgInput" placeholder="Type a message" autocomplete="off"/>
        <button class="msg-send-btn" id="sendMsgBtn">Send</button>
      </div>
    </div>
  </div>

<script>
  const username = localStorage.getItem('username');
  if(!username) window.location.href = 'login.html';

  let currentChatUser = null; // user object
  let allUsers = []; // all users data
  let currentUserProfilePic = "";

  function loadProfilePic() {
    // Load profile pic from localStorage(if uploaded), fallback default.png
    currentUserProfilePic = localStorage.getItem("profilePic") || "default.png";
    document.getElementById("profilePicNavbar").src = currentUserProfilePic;
  }

  async function loadUsers() {
    try {
      const res = await fetch(`/users/${username}`);
      if (!res.ok) throw new Error("Could not fetch users");
      allUsers = await res.json();
      renderUsers(allUsers);
    } catch (e) {
      document.getElementById('userList').innerHTML =
        '<div style="color:#f44;padding:14px">Could not load users.</div>';
      console.error(e);
    }
  }

  function renderUsers(users) {
    const userList = document.getElementById('userList');
    userList.innerHTML = '';
    users.forEach(user => {
      if(user.username === username) return; // skip self
      const div = document.createElement('div');
      div.className = "contact";

      const img = document.createElement('img');
      img.className = "contact-img";
      img.src = user.profilePic ? `/uploads/${user.profilePic}` : 'default.png';
      img.onerror = ()=>img.src = "default.png";

      const details = document.createElement('div');
      details.className = "contact-details";

      const nameDiv = document.createElement('div');
      nameDiv.className = "contact-username";
      nameDiv.textContent = user.username;

      const lastSeenDiv = document.createElement('div');
      lastSeenDiv.className = "contact-lastseen";
      if(user.online) {
        lastSeenDiv.textContent = "online";
        let dot = document.createElement("span"); dot.className = "online-dot";
        div.appendChild(dot);
      } else if(user.lastSeen) {
        let minAgo = Math.floor((Date.now() - user.lastSeen) / 60000);
        lastSeenDiv.textContent = minAgo < 1 ? "just now" : `${minAgo} min ago`;
      } else lastSeenDiv.textContent = "offline";

      details.appendChild(nameDiv);
      details.appendChild(lastSeenDiv);

      const addBtn = document.createElement('button');
      addBtn.className = "friend-btn";
      addBtn.textContent = "Add Friend";
      addBtn.onclick = e => {
        e.stopPropagation();
        alert("Add friend functionality coming soon!");
      };

      div.onclick = () => openChat(user, div);

      div.appendChild(img);
      div.appendChild(details);
      div.appendChild(addBtn);

      userList.appendChild(div);
    });
  }

  // Search users
  document.getElementById("searchBar").addEventListener("input", (e) => {
    const q = e.target.value.trim().toLowerCase();
    const filtered = q
      ? allUsers.filter(u => u.username !== username && u.username.toLowerCase().includes(q))
      : allUsers.filter(u => u.username !== username);
    renderUsers(filtered);
  });

  function openChat(user, div) {
    currentChatUser = user;
    // Active highlight in user list
    Array.from(document.getElementsByClassName("contact")).forEach(c => c.classList.remove("active"));
    if(div) div.classList.add("active");
    document.getElementById("chatHeaderText").textContent = `Chat with ${user.username}`;
    document.getElementById('chatInputBar').style.display = 'flex';

    // Mobile: show chat only, hide contacts
    if(window.innerWidth <= 700) {
      document.body.classList.add('show-chat');
      document.getElementById('backBtn').style.display = 'inline-block';
    }
    loadMessages();
  }

  async function loadMessages() {
    const chatDiv = document.getElementById('chatMessages');
    chatDiv.innerHTML = '';
    if(!currentChatUser) return;
    try {
      const res = await fetch(`/chat/${username}/${currentChatUser.username}`);
      if(!res.ok) throw new Error();
      const msgs = await res.json();
      msgs.forEach((msg, idx) => {
        const isMe = msg.from === username;
        let row = document.createElement('div');
        row.className = 'chat-bubble-row' + (isMe ? ' me' : '');

        let img = document.createElement('img');
        img.className = "chat-bubble-avatar";
        img.src = isMe
          ? (currentUserProfilePic || "default.png")
          : (currentChatUser.profilePic ? `/uploads/${currentChatUser.profilePic}` : "default.png");
        img.onerror = ()=> img.src = "default.png";

        let box = document.createElement('div');
        box.className = "chat-bubble";
        if(isMe) box.classList.add("me");
        box.textContent = msg.message;

        if(isMe && idx === msgs.length -1 && msg.seen) {
          let seen = document.createElement('span');
          seen.className = "seen-tick";
          seen.textContent = "✔✔";
          box.appendChild(seen);
        }

        row.appendChild(img);
        row.appendChild(box);
        chatDiv.appendChild(row);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    } catch (e) {
      chatDiv.innerHTML = "<div style='color:#d22;padding:8px'>Failed to load chat.</div>";
      console.error(e);
    }
  }

  async function sendMessage() {
    const inp = document.getElementById("chatMsgInput");
    const msg = inp.value.trim();
    if(!msg || !currentChatUser) return;
    try {
      let res = await fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ from: username, to: currentChatUser.username, message: msg })
      });
      if(res.ok) {
        inp.value = "";
        loadMessages();
      }
    } catch (e) {
      alert("Failed to send.");
      console.error(e);
    }
  }

  document.getElementById("sendMsgBtn").onclick = sendMessage;
  document.getElementById("chatMsgInput").onkeypress = (e) => {
    if(e.key === "Enter") sendMessage();
  };

  // Back button on mobile to show contacts list again
  document.getElementById("backBtn").onclick = function() {
    currentChatUser = null;
    document.body.classList.remove('show-chat');
    document.getElementById("chatHeaderText").textContent = "Select a user to chat";
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('chatInputBar').style.display = 'none';
    this.style.display = 'none';
    // Remove active highlight from contact list
    Array.from(document.getElementsByClassName("contact")).forEach(c => c.classList.remove("active"));
  };

  window.addEventListener("resize", () => {
    if(window.innerWidth > 700) {
      document.body.classList.remove('show-chat');
      document.getElementById('backBtn').style.display = 'none';
    }
  });

  // Auto refresh messages every 2 seconds if chat open
  setInterval(() => {
    if(currentChatUser) loadMessages();
  }, 2000);

  // Init
  loadProfilePic();
  loadUsers();
</script>
</body>
</html>
